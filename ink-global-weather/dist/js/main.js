define("model",["require"],function(e){function t(e){this.id=0;if(e!=null)for(var t in e){var n=e[t];this[t]=n}}return t.prototype={Load:function(){return null},Save:function(){return!1}},t}),define("ui-toolbox",["require"],function(require){function Toolbox(){console&&console.log("WARNING: You do not need to call new Toolbox(). You can use it directly, e.g., Toolbox.addClass(...)")}return Toolbox.reduce=function(e,t,n){var r="";for(var i=0;i<e.length;i++)i>0&&(r+=t),n!=null?r+=n(e[i]):r+=e[i];return r},Toolbox.addClass=function(e,t){if(e==null){console&&console.log("ERROR: Toolbox.addClass with null element");return}if(e.length==null||e.value!=null)e=[e];Toolbox.removeClass(e,t);for(var n=0;n<e.length;n++)e[n].className+=" "+t},Toolbox.removeClass=function(e,t){if(e==null){console&&console.log("Called removeClass with null element"),console&&console.trace();return}if(e.length==null||e.value!=null)e=[e];for(var n=0;n<e.length;n++){var r=e[n];if(r.className==null)return;var i=r.className.split(" "),s=new Array;for(var o=i.length;o>0;)i[--o]!=t&&(s[s.length]=i[o]);r.className=s.join(" ")}},Toolbox.hasClass=function(e,t){if(e==null||e.className==null)return null;var n=e.className.split(" ");for(var r=n.length;r>0;)if(n[--r]==t)return!0;return!1},Toolbox.toggleClass=function(e,t){Toolbox.hasClass(e,t)===!0?Toolbox.removeClass(e,t):Toolbox.addClass(e,t)},Toolbox.getElement=function(e,t){return t!=null?t.querySelector(e):document.querySelector(e)},Toolbox.getAllElements=function(e,t){return t!=null?t.querySelectorAll(e):document.querySelectorAll(e)},Toolbox.getElementsByClass=function(e,t){t||(t=document);var n=t.getElementsByTagName("*"),r=-1,i,s=[];while(i=n[++r])(" "+(i["class"]||i.className)+" ").indexOf(" "+e+" ")>-1&&s.push(i);return s},Toolbox.getAttribute=function(e,t){if(e==null){console&&console.log("Called getAttribute with null element"),console&&console.trace();return}if(e.attributes==null){console&&console.log("Called getAttribute with invalid element that does not have attributes"),console&&console.trace();return}if(typeof e.getAttribute=="function")return e.getAttribute(t);for(var n=0;n<e.attributes.length;n++)if(e.attributes[n].nodeName==t)return e.attributes[n].value;return null},Toolbox.setAttribute=function(e,t,n){if(e==null){console&&console.log("Called getAttribute with null element"),console&&console.trace();return}if(e.attributes==null){console&&console.log("Called getAttribute with invalid element that does not have attributes"),console&&console.trace();return}if(typeof e.setAttribute=="function"){e.setAttribute(t,n);var r=e.getAttribute(t);if(r!=n&&e.attributes==null){console&&console.log("ERROR: Failure to setAttribute and retrieve back value");return}}else e[t]=n;return!0},Toolbox.onEvent=function(e,t,n){var r=[];if(t==null){console&&console.log("ERROR: Toolbox.onEvent with null element");return}if(t.length==null||t.value!=null)t=[t];for(var i=0;i<t.length;i++){var s=t[i];if(s.attachEvent){var o=function(e){return function(t){t.currentTarget=e,n.call(e,t)}},u=o(s);s.attachEvent("on"+e,u);var a=function(e,t,n){return function(){e.detachEvent("on"+t,n)}};r.push(a(s,e,u))}else if(s.addEventListener){s.addEventListener(e,n,!1);var a=function(e,t,n){return function(){e.removeEventListener(t,n,!1)}};r.push(a(s,e,n))}else{s["on"+e]=n;var a=function(e,t){return function(){e["on"+t]=null}};r.push(a(s,e))}}return r},Toolbox.onClick=function(e,t){return Toolbox.onEvent("click",e,t)},Toolbox.onChange=function(e,t){return Toolbox.onEvent("change",e,t)},Toolbox.onSelectChange=function(e,t){var n=Toolbox.onEvent("keyup",e,t);return n.push.apply(n,Toolbox.onEvent("change",e,t)),n},Toolbox.Replace=function(html,model){for(;;){var nextLogic=html.indexOf("%%if"),nextLoop=html.indexOf("%%loop");if(nextLoop>0&&(nextLogic>nextLoop||nextLogic==-1)){var loop=html.match(/%%loop ?\( ?(((?!%%).)*) ?\) ?%%(((?!%%end%%)[\S\s])*)%%end%%/);if(loop&&loop.length&&loop.length>=5){var myArray=model[loop[1]];if(Object.prototype.toString.call(model[loop[1]])==="[object Array]"){var chunks="";for(var level2 in model[loop[1]]){var chunk=Toolbox.Replace(loop[3],model[loop[1]][level2]);chunks+=chunk}html=html.replace(loop[0],chunks)}else html=html.replace(loop[0],"")}}var logic=html.match(/%%if ?(((?!%%).)*)%%(((?!%%endif%%).)*)%%endif%%/);if(logic&&logic.length&&logic.length>=5){logic[1]=logic[1].replace(/&amp;/g,"&");var result=eval(logic[1]);if(result){var chunk=Toolbox.Replace(logic[3],model);html=html.replace(logic[0],chunk)}else html=html.replace(logic[0],"")}else{nextLoop=html.indexOf("%%loop");if(nextLoop==-1)break}}return html=Toolbox.ReplacePlain(html,model),html},Toolbox.ReplacePlain=function(e,t){var n;for(var r in t)if(typeof t[r]=="object")for(var i in t[r])if(Object.prototype.toString.call(t[r])==="[object Array]")if(typeof t[r][i]=="object")for(var s in t[r][i])n=new RegExp("%%"+r+"\\["+i+"\\]\\."+s+"%%","g"),e=e.replace(n,t[r][i][s]);else n=new RegExp("%%"+r+"\\["+i+"\\]%%","g"),e=e.replace(n,t[r][i]);else n=new RegExp("%%"+r+"\\."+i+"%%","g"),e=e.replace(n,t[r][i]);else n=new RegExp("%%"+r+"%%","g"),e=e.replace(n,t[r]);return e},Toolbox.ReplaceInPlace=function(e,t,n){var r;n==null&&(n="");for(var i in t)if(Object.prototype.toString.call(t[i])==="[object Array]")for(var s in t[i])Toolbox.ReplaceInPlace(e,t[i][s],n+i+"["+s+"].");else if(typeof t[i]=="object")Toolbox.ReplaceInPlace(e,t[i],n+i+".");else{var o='data-target="'+n+i,u=Toolbox.getAllElements("["+o+'"]',e);u.length>0&&Toolbox.innerHTML(u,t[i])}},Toolbox.innerHTML=function(e,t){if(e==null){console&&console.log("ERROR: Toolbox.innerHTML with null element");return}if(e.length==null||e.value!=null)e=[e];for(var n=0;n<e.length;n++){var r=e[n];r.innerHTML=t}return e},Toolbox.jsonp=function(e,t){var n=document.head||document.documentElement,r=document.createElement("script");r.async=!0,r.charset="utf-8",r.callbackName="uiToolbox"+(Math.random()*12).toString().replace(".","");var i=e.match(/callback=([^&]*)/);i?r.callbackName=i:(e.indexOf("?")==-1?e+="?":e+="&",e+="callback="+r.callbackName,window[r.callbackName]=function(e){t(e)},setTimeout(function(){if(r==null)return;window[r.callbackName]=null},3e4)),r.src=e,r.onload=r.onreadystatechange=function(){if(!r.readyState||/loaded|complete/.test(r.readyState))r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),window[r.callbackName]=null,r=null},r.abort=function(){r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),window[r.callbackName]=null,r=null},n.insertBefore(r,n.firstChild)},Toolbox.ajax=function(e){var t=!1;if(typeof XMLHttpRequest!="undefined")try{t=new XMLHttpRequest}catch(n){t=!1}if(t===!1&&window.createRequest)try{t=window.createRequest()}catch(n){t=!1}t===!1;if(t===!1)return!1;var r=(new Date).getTime();requestString+="&_t="+r,spanDebug&&(spanDebug.innerHTML=g_time_request+" HTTP request ready to be sent<br>\n"),spanDebug&&(spanDebug.innerHTML+=requestString+"<br>\n"),e.jsonp===!0;var i=!0;t.open("GET",requestString,i),t.onreadystatechange=function(){t.readyState==4};try{t.send(null)}catch(n){console&&console.log("[xmlhttp] Error send(): "+n)}},Toolbox});var g_tester=0;define("weather-source-api",["require","ui-toolbox"],function(e){var t=e("ui-toolbox"),n=function(){return g_tester++,g_tester>1&&console.log("not singleton"),{Fetch:function(e,n){var r=this;e.length==null&&(e=[e]);var i=t.reduce(e,",",function(e){return e.id}),s="http://api.openweathermap.org/data/2.5/group?id="+i+"&units=metric&APPID=e271b63b2339a298bfbf2affdf92efbe";t.jsonp(s,function(t){if(t.list==null){console&&console.log("ERROR: API return doesn't include .list"),n&&n(!1);return}if(t.list.length==0){console&&console.log("ERROR: API returned an empty list, check for valid IDs"),n&&n(!1);return}for(var r=0;r<t.list.length;r++){var i=t.list[r],s=null;for(var o=0;o<e.length;o++)e[o].id==i.id&&(s=e[o]);if(s==null){console&&console.log("ERROR: Could not match city.id with data from API"),n&&n(!1);return}for(var u in i)s[u]=i[u];s.afterLoad!=null&&s.afterLoad()}n(!0)})}}};return n()}),define("city",["require","model","weather-source-api"],function(e){function r(e){this.defaults=[],t.call(this,e)}var t=e("model"),n=e("weather-source-api");return r.prototype=new t,r.prototype.constructor=r,r.prototype.Load=function(e){var t=this;return n.Fetch(t,function(t){e(t)}),this},r.prototype.afterLoad=function(){for(var e in this.main)this[e]=this.main[e];this.temp=Math.round(this.temp*10)/10,this.temp_min=Math.round(this.temp_min*10)/10,this.temp_max=Math.round(this.temp_max*10)/10,this.weatherDescription="";for(var t=0;t<this.weather.length;t++)t>0&&(this.weatherDescription+=", "),this.weatherDescription+=this.weather[t].description},r}),define("view-manager",["require","ui-toolbox"],function(require){function ViewManager(e,t){this.controller=e,this.elements=t,this.unbinders=[],this.sortByArea=Toolbox.getElement(t.sortByArea.selector),this.viewListArea=Toolbox.getElement(t.viewListArea.selector),this.fullDisplayArea=Toolbox.getElement(t.fullDisplayArea.selector),this.tmplCity=Toolbox.getElement(t.tmplCity.selector),this.tmplIcon=Toolbox.getElement(t.tmplIcon.selector),this.cityListInsertionPoint=Toolbox.getElement(t.cityListInsertionPoint.selector),this.sortMethod=Toolbox.getElement(t.sortMethod.selector),this.cityDiv=Toolbox.getAllElements(t.cityDiv.selector),this.Initialize()}var Toolbox=require("ui-toolbox"),sortByTemperatureR=function(e,t){return e.temp<t.temp?1:e.temp>t.temp?-1:0},sortByTemperature=function(e,t){return e.temp<t.temp?-1:e.temp>t.temp?1:0},sortByName=function(e,t){return e.name<t.name?-1:e.name>t.name?1:0};return ViewManager.prototype={bindAll:function(){var e=this;Toolbox.onSelectChange(e.sortMethod,function(t){e.elements.sortMethod.func(e.controller,t)}),Toolbox.onClick(e.viewListArea,function(t){e.elements.viewListArea.func(e.controller,t)})},render:function(e){var t=this,n="";for(var r=0;r<t.unbinders.length;r++)t.unbinders[r]();this.currentSort!=e&&(e=="rtemp"&&this.cities.sort(sortByTemperatureR),e=="temp"?this.cities.sort(sortByTemperature):e=="name"&&this.cities.sort(sortByName),this.currentSort=e);for(var r=0;r<this.cities.length;r++)n+=this.renderOneCityInList(this.cities[r]);var i=document.createElement("div");i.innerHTML=n,i.className="listContainer";var s=i.firstChild;this.cityListInsertionPoint.innerHTML="",this.cityListInsertionPoint.appendChild(i);var o=Toolbox.getAllElements(this.elements.cityDiv.selector,this.cityListInsertionPoint);if(this.cities.length>0&&this.cities[0].weather==null)return;t.unbinders=Toolbox.onClick(o,function(e){var n=e.currentTarget;if(Toolbox.hasClass(n,"selected")===!0){t.renderCityList();return}Toolbox.addClass(n,"selected");var r=Toolbox.getAllElements(t.elements.cityDiv.selector,t.cityListInsertionPoint),i=[];for(var s=r.length-1;s>=0;s--)r[s]!=n&&i.push(r[s]);Toolbox.addClass(i,"fadeOut"),setTimeout(function(){Toolbox.addClass(i,"hidden"),Toolbox.addClass(n,"marginAlignCenter");var e=Toolbox.getAttribute(n,"cityId");t.elements.cityDiv.func(t.controller,e)},500)})},renderOneCityInList:function(city){var html=this.tmplCity.innerHTML;for(;;){var logic=html.match(/%%if ?(((?!%%).)*)%%(((?!%%endif%%)[\S\s])*)%%endif%%/);if(!(logic&&logic.length&&logic.length>=5))break;logic[1]=logic[1].replace(/&amp;/g,"&");var result=eval(logic[1]);if(result){var chunk=Toolbox.ReplacePlain(logic[3],city);html=html.replace(logic[0],chunk)}else html=html.replace(logic[0],"")}return html=Toolbox.ReplacePlain(html,city),html},renderFullCity:function(e){Toolbox.addClass(this.sortByArea,"hidden"),Toolbox.removeClass(this.viewListArea,"hidden"),Toolbox.removeClass(this.fullDisplayArea,"hidden"),Toolbox.ReplaceInPlace(this.fullDisplayArea,e);var t=Toolbox.getAllElements("[data-template]",this.fullDisplayArea);for(var n=0;n<t.length;n++){var r=Toolbox.getAttribute(t[n],"data-template"),i=Toolbox.getElement("#"+r);if(i!=null){var s=i.innerHTML;s=Toolbox.Replace(s,e),t[n].innerHTML=s}}},renderCityList:function(){var e=this;Toolbox.addClass(this.viewListArea,"hidden"),Toolbox.removeClass(this.sortByArea,"hidden"),Toolbox.addClass(this.fullDisplayArea,"hidden");var t=Toolbox.getAllElements(e.elements.cityDiv.selector,e.cityListInsertionPoint);Toolbox.removeClass(t,"fadeOut"),Toolbox.removeClass(t,"hidden"),Toolbox.removeClass(t,"selected"),Toolbox.removeClass(t,"marginAlignCenter")},setCities:function(e){this.cities=e},Initialize:function(){this.bindAll()}},ViewManager}),define("controller",["require","city","view-manager","ui-toolbox","weather-source-api"],function(e){function u(){this.theView=null,this.theCities=[],this.settings={cities:[],sortMethod:"name"}}var t=e("city"),n=e("view-manager"),r=e("ui-toolbox"),i=e("weather-source-api"),s=!0,o=0;return u.prototype={onSortMethodChanged:function(e,t){var n=t!=null?t.currentTarget:null;console&&console.log("[main] onSortMethodChanged:"+n.value),e.settings.sortMethod=n.value,e.theView.render(e.settings.sortMethod)},viewListDisplay:function(e){e.theView.renderCityList()},cityFullDisplay:function(e,t){for(var n=0;n<e.theCities.length;n++)e.theCities[n].id==t&&e.theView.renderFullCity(e.theCities[n])},Init:function(e,r){var s=this;e.cities&&(this.settings.cities=e.cities),e.sortMethod&&(this.settings.sortMethod=e.sortMethod);for(var o=0;o<this.settings.cities.length;o++){var u=new t({id:this.settings.cities[o].id,name:this.settings.cities[o].name});this.theCities.push(u)}var a={sortByArea:{selector:"#sortBy",func:null},viewListArea:{selector:"#viewList",func:s.viewListDisplay},fullDisplayArea:{selector:"#fullDisplayArea",func:null},tmplCity:{selector:"#tmplCity",func:null},tmplIcon:{selector:"#tmplIcon",func:null},cityListInsertionPoint:{selector:"#city-list",func:null},sortMethod:{selector:"#sortMethod",func:s.onSortMethodChanged},cityDiv:{selector:"div.city",func:s.cityFullDisplay}};return this.theView=new n(this,a),this.theView.setCities(this.theCities),this.theView.render(this.settings.sortMethod),i.Fetch(this.theCities,function(e){s.theView.render(s.settings.sortMethod),r&&r(e)}),this}},u}),define("main",["require","controller"],function(e){function s(){if(i)return;i=!0;if(n){var e=(new Date).getTime();diff=e-r,console.log("Controller: document.ready at t="+e+" diff("+diff+")"),r=e}var s={cities:[{name:"London",id:2643743},{name:"Luton",id:2643339},{name:"Manchester",id:2643123},{name:"Birmingham",id:2655603},{name:"Sherbrooke",id:6146143},{name:"Paris",id:2988507}],sortMethod:"name"};(new t).Init(s)}function o(){document.removeEventListener("DOMContentLoaded",o,!1),window.removeEventListener("load",o,!1),s()}var t=e("controller"),n=!1,r=0,i=!1;document.readyState==="complete"?setTimeout(s):(document.addEventListener("DOMContentLoaded",o,!1),window.addEventListener("load",o,!1));if(n){var u=(new Date).getTime();r=u,console.log("Controller: started at t="+u)}return{amd:!0}});