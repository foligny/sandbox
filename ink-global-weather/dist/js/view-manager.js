define(["require","ui-toolbox"],function(require){function ViewManager(e,t){this.controller=e,this.elements=t,this.unbinders=[],this.sortByArea=Toolbox.getElement(t.sortByArea.selector),this.viewListArea=Toolbox.getElement(t.viewListArea.selector),this.fullDisplayArea=Toolbox.getElement(t.fullDisplayArea.selector),this.tmplCity=Toolbox.getElement(t.tmplCity.selector),this.tmplIcon=Toolbox.getElement(t.tmplIcon.selector),this.cityListInsertionPoint=Toolbox.getElement(t.cityListInsertionPoint.selector),this.sortMethod=Toolbox.getElement(t.sortMethod.selector),this.cityDiv=Toolbox.getAllElements(t.cityDiv.selector),this.Initialize()}var Toolbox=require("ui-toolbox"),sortByTemperatureR=function(e,t){return e.temp<t.temp?1:e.temp>t.temp?-1:0},sortByTemperature=function(e,t){return e.temp<t.temp?-1:e.temp>t.temp?1:0},sortByName=function(e,t){return e.name<t.name?-1:e.name>t.name?1:0};return ViewManager.prototype={bindAll:function(){var e=this;Toolbox.onSelectChange(e.sortMethod,function(t){e.elements.sortMethod.func(e.controller,t)}),Toolbox.onClick(e.viewListArea,function(t){e.elements.viewListArea.func(e.controller,t)})},render:function(e){var t=this,n="";for(var r=0;r<t.unbinders.length;r++)t.unbinders[r]();this.currentSort!=e&&(e=="rtemp"&&this.cities.sort(sortByTemperatureR),e=="temp"?this.cities.sort(sortByTemperature):e=="name"&&this.cities.sort(sortByName),this.currentSort=e);for(var r=0;r<this.cities.length;r++)n+=this.renderOneCityInList(this.cities[r]);var i=document.createElement("div");i.innerHTML=n,i.className="listContainer";var s=i.firstChild;this.cityListInsertionPoint.innerHTML="",this.cityListInsertionPoint.appendChild(i);var o=Toolbox.getAllElements(this.elements.cityDiv.selector,this.cityListInsertionPoint);if(this.cities.length>0&&this.cities[0].weather==null)return;t.unbinders=Toolbox.onClick(o,function(e){var n=e.currentTarget;if(Toolbox.hasClass(n,"selected")===!0){t.renderCityList();return}Toolbox.addClass(n,"selected");var r=Toolbox.getAllElements(t.elements.cityDiv.selector,t.cityListInsertionPoint),i=[];for(var s=r.length-1;s>=0;s--)r[s]!=n&&i.push(r[s]);Toolbox.addClass(i,"fadeOut"),setTimeout(function(){Toolbox.addClass(i,"hidden"),Toolbox.addClass(n,"marginAlignCenter");var e=Toolbox.getAttribute(n,"cityId");t.elements.cityDiv.func(t.controller,e)},500)})},renderOneCityInList:function(city){var html=this.tmplCity.innerHTML;for(;;){var logic=html.match(/%%if ?(((?!%%).)*)%%(((?!%%endif%%)[\S\s])*)%%endif%%/);if(!(logic&&logic.length&&logic.length>=5))break;logic[1]=logic[1].replace(/&amp;/g,"&");var result=eval(logic[1]);if(result){var chunk=Toolbox.ReplacePlain(logic[3],city);html=html.replace(logic[0],chunk)}else html=html.replace(logic[0],"")}return html=Toolbox.ReplacePlain(html,city),html},renderFullCity:function(e){Toolbox.addClass(this.sortByArea,"hidden"),Toolbox.removeClass(this.viewListArea,"hidden"),Toolbox.removeClass(this.fullDisplayArea,"hidden"),Toolbox.ReplaceInPlace(this.fullDisplayArea,e);var t=Toolbox.getAllElements("[data-template]",this.fullDisplayArea);for(var n=0;n<t.length;n++){var r=Toolbox.getAttribute(t[n],"data-template"),i=Toolbox.getElement("#"+r);if(i!=null){var s=i.innerHTML;s=Toolbox.Replace(s,e),t[n].innerHTML=s}}},renderCityList:function(){var e=this;Toolbox.addClass(this.viewListArea,"hidden"),Toolbox.removeClass(this.sortByArea,"hidden"),Toolbox.addClass(this.fullDisplayArea,"hidden");var t=Toolbox.getAllElements(e.elements.cityDiv.selector,e.cityListInsertionPoint);Toolbox.removeClass(t,"fadeOut"),Toolbox.removeClass(t,"hidden"),Toolbox.removeClass(t,"selected"),Toolbox.removeClass(t,"marginAlignCenter")},setCities:function(e){this.cities=e},Initialize:function(){this.bindAll()}},ViewManager});